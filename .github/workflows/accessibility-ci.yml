name: Automated Accessibility Scan

on:
  push:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  a11y-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install -g @axe-core/cli serve jq

      - name: Serve site
        run: |
          serve . -l 3000 &
          sleep 5

      - name: Run accessibility scan
        run: |
          axe http://localhost:3000/before.html \
            --format json \
            --save a11y-report.json || true

      - name: Parse report and create individual issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          count=$(jq '.violations | length' a11y-report.json)
          if [ "$count" -eq 0 ]; then
            echo "No accessibility issues found."
            exit 0
          fi

          jq -c '.violations[]' a11y-report.json | while read -r violation; do
            rule=$(echo "$violation" | jq -r '.id')
            desc=$(echo "$violation" | jq -r '.description')
            help=$(echo "$violation" | jq -r '.helpUrl')
            snippet=$(echo "$violation" | jq -r '.nodes[0].html' | sed 's/`/"/g')

cat <<EOF > issue.md
### Accessibility Issue: $rule

**Description:**
$desc

**Impacted HTML Example:**
\`\`\`html
$snippet
\`\`\`

ðŸ”— WCAG Ref: $help  
ðŸ“Œ Auto-generated â€” please fix and open a PR
EOF

            gh issue create \
              --title "Fix: $rule accessibility violation" \
              --body-file issue.md \
              --label "a11y-scan" \
              --label "copilot:accessibility"
          done

      - name: Upload full JSON report
        uses: actions/upload-artifact@v4
        with:
          name: a11y-scan-report
          path: a11y-report.json
